{include file="public/header" /}
<body>
<div class="x-body layui-anim layui-anim-up">
  <form class="layui-form" action="{$update|default='/'}"  method="post" enctype="multipart/form-data">

    <div class="layui-form-item">
      <label for="class_name" class="layui-form-label">分类名称<?php html_sign();?></label>
      <div class="layui-input-block">
        <input class="layui-input" id="class_name" name="class_name" lay-verify="required" value="{$list.class_name|default=''}">
      </div>
    </div>
	
    <div class="layui-form-item">
      <label class="layui-form-label">图片上传<?php html_sign();?></label>
        <div class="layui-upload">
           <div style="float: left;width: 150px; text-align: center; margin-left:20px ">
              <button type="button" class="layui-btn" id="imgs">App图片</button>
            <div class="layui-upload-list">
              <img class="layui-upload-img" id="img2" width="150" src="{$list.image_urls|default=$list.file_path}">
            </div>
           </div>
        </div>
    </div>
    <input type="hidden"  name="app_image_id"  id="FImageUrl" value="{$list.app_image_id|0}">
    <input type="hidden"  name="web_image_id"  id="FImageUrls" value="{$list.app_image_id|0}">

    <div class="layui-form-item">
    <label class="layui-form-label">多图片上传</label>
    <div class="layui-upload">
      <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button>
      <button type="button" class="layui-btn" style="margin-left:150px;" id="testListAction">开始上传</button>
      <div class="layui-upload-list">
        <table class="layui-table">
          <thead>
            <tr>
              <th>文件名</th>
              <th>预览</th>
              <th>大小</th>
              <th>上传状态</th>
              <th>审核状态</th>
              <th>操作</th>
          </tr>
        </thead>
        <tbody id="demoList">
          {if condition="isset($list.image_ids) and $arr_image" }
                {volist name="$arr_image" id="v"}
                  <tr>
                      <td>{$v.file_name|default=$v.file_path}</td>
                      <td><img src='{$v.file_path|default=""}'></td>
                      <td>{$v.file_size|default=0}kb</td>
                      <td><span style="color: #5FB878;">上传成功</span></td>
                      <td><span style="color: #5FB878;">{if condition="$v.record_status eq 1"}通过{else}审核中{/if}</span></td>
                      <td>
                        <a class="layui-btn layui-btn-xs layui-btn-danger demo-delete" onclick="image_del('{$v.fid}','/meet/del_photo','{$edit|default='/'}','{$list.convention_id|default=$convention_id}',1)">删除</a>
						&nbsp;&nbsp;<a title="禁用" class="layui-btn" href="javascript:;" onclick="image_del('{$v.fid}','/meet/del_photo','{$edit|default='/'}','{$list.convention_id|default=$convention_id}',2)">
							{if condition="$v.record_status eq 1"}不通过{else}通过{/if}
						</a>
                      </td>
                  </tr>
                {/volist}  
          {/if}
        </tbody>
        </table>
      </div>
    </div> 
	
    <div class="layui-form-item">
      <label for="sort" class="layui-form-label">排序</label>
      <div class="layui-input-block">
        <input class="layui-input" id="sort" name="sort" value="{$list.sort|default=0}">
      </div>
    </div>
  
    <div class="layui-form-item">
      <label class="layui-form-label xbs768">状态</label>
      <div class="layui-input-block">
        <input type="radio" name="record_status" value="1" title="启用" checked>
        <input type="radio" name="record_status" value="2" title="禁用" {if condition="isset($list['record_status']) and $list['record_status'] eq 2"} checked {/if}>
        <input type="radio" name="record_status" value="-1" title="标记删除" {if condition="isset($list['record_status']) and  $list['record_status'] eq -1"} checked {/if}>
      </div>
    </div>
    <input type="hidden" name="fid" value="{$list.fid|default=''}">
    <input type="hidden" name="convention_id" value="{$list.convention_id|default=$convention_id}">
    <input type="hidden" name="image_ids"  id="image_ids" value="{$list.image_ids|default=''}">
    <span id='msj'></span>

    <div class="layui-form-item">
      <label class="layui-form-label"></label>
      <button class="layui-btn" lay-filter="save" lay-submit="" type="submit">保存</button>
    </div>
  </form>
</div>
<script>
  layui.use('upload',function(){
	  var $ = layui.jquery
	  ,upload = layui.upload;
	  var app_image_id='{$list.app_image_id|0}';
	  //APP图片上传
	  var uploadInst2 = upload.render({
		elem: '#imgs'
		,url: '/upload'
		,data: {app_image_id:app_image_id,source_type:1}
		,acceptMime: 'image/*'
		,before: function(obj){
		  obj.preview(function(index, file, result){
			$('#img2').attr('src', result);
		  });
		}
		,done: function(res){
		  if(res.code == 200){
			$('#FImageUrl,#FImageUrls').attr('value', res.data);
			return layer.msg('上传成功');
		  }else{
			return layer.msg('上传失败');
		  }
		}
	  });
});    
</script>
<script>
  layui.use('upload',function(){
     var $ = layui.jquery
    ,upload = layui.upload;  
    //多文件列表示例
  var demoListView = $('#demoList')
  ,uploadListIns = upload.render({
    elem: '#testList'
    ,url: '/upload'
    ,accept: 'file'
    ,multiple: true
    ,data: {web_image_id:0}
    ,exts: 'jpg|png|gif|jpeg'
    ,size: 1024*5
    ,acceptMime: 'image/*'
    ,auto: false
    ,bindAction: '#testListAction'
    ,choose: function(obj){   
      var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
      //读取本地文件
      obj.preview(function(index, file, result){
        var tr = $(['<tr id="upload-'+ index +'">'
          ,'<td>'+ file.name +'</td>'
          ,'<td><img src='+ result +'></td>'
          ,'<td>'+ (file.size/1014).toFixed(1) +'kb</td>'
          ,'<td>等待上传</td>'
          ,'<td>'
            ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
            ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
          ,'</td>'
        ,'</tr>'].join(''));
        
        //单个重传
        tr.find('.demo-reload').on('click', function(){
          obj.upload(index, file);
        });
        
        //删除
        tr.find('.demo-delete').on('click', function(){
          delete files[index]; //删除对应的文件
          tr.remove();
          uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
        });
        
        demoListView.append(tr);
      });
    }
    ,done: function(res, index, upload){
      if(res.code == 200){ //上传成功
        var image_ids=$("#image_ids").val();
        if(image_ids){
            var html=','+res.data;
        }else{
            var html=res.data;
        }
        $("#image_ids").val(image_ids +html);
        var tr = demoListView.find('tr#upload-'+ index)
        ,tds = tr.children();
        tds.eq(3).html('<span style="color: #5FB878;">上传成功</span>');
        tds.eq(4).html('<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'); //清空操作
        return delete this.files[index]; //删除文件队列已经上传成功的文件
      }
      this.error(index, upload);
    }
    ,error: function(index, upload){
      var tr = demoListView.find('tr#upload-'+ index)
      ,tds = tr.children();
      tds.eq(3).html('<span style="color: #FF5722;">上传失败</span>');
      tds.eq(4).find('.demo-reload').removeClass('layui-hide'); //显示重传
    }
  });
});
</script>

<script>
    //发异步删除数据
    function image_del(fid,url,urls,pid,type){
    var id='{$list.fid|default=""}';
    $.ajax({
      type: "post",
      url: url,
      data: {fid:id,type:type,photo_id:fid},
      dataType: "json",
      success: function (data) {
        if (data.code == 1) {
          layer.msg(data.msg, {icon: 1, time: 500});
        } else {
          layer.msg(data.msg, {icon: 1, time: 500});
        }
        setTimeout(function () {
           window.location.href = urls + "?fid="+id+"&convention_id="+pid;
        }, 500);
      }
    });
  }
</script>

</body>
</html>